function doPost(e) {
  // Handle both text/plain and application/json
  const data = typeof e.postData.contents === 'string' 
    ? JSON.parse(e.postData.contents) 
    : e.postData.contents;
  
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Training Log 2026');
  
  // Handle adding a new lift
  if (data.action === 'addLift') {
    return addNewLift(data.category, data.liftName);
  }
  
  // Handle editing existing entry
  if (data.action === 'editEntry') {
    return editEntry(sheet, data);
  }
  
  // Check if this is multiple entries (array)
  if (data.entries && Array.isArray(data.entries)) {
    // Each entry in the array gets its own row
    data.entries.forEach(entry => {
      writeWorkoutRow(sheet, entry);
    });
  } else {
    // Single entry (backwards compatible)
    writeWorkoutRow(sheet, data);
  }
  
  return ContentService.createTextOutput(JSON.stringify({success: true}))
    .setMimeType(ContentService.MimeType.JSON);
}

function editEntry(sheet, data) {
  const row = data.row;
  
  // Update squat if provided
  if (data.squat !== undefined) {
    if (data.squat === null) {
      // Clear squat section
      sheet.getRange(row, 2, 1, 5).clearContent();
    } else if (data.squat.lift) {
      sheet.getRange(row, 2).setValue(data.squat.lift);
      sheet.getRange(row, 3).setValue('WS');
      if (data.squat.data) {
        sheet.getRange(row, 4).setValue(data.squat.data.sets);
        sheet.getRange(row, 5).setValue(data.squat.data.reps);
        sheet.getRange(row, 6).setValue(data.squat.data.weight);
      }
    }
  }
  
  // Update press if provided
  if (data.press !== undefined) {
    if (data.press === null) {
      sheet.getRange(row, 8, 1, 5).clearContent();
    } else if (data.press.lift) {
      sheet.getRange(row, 8).setValue(data.press.lift);
      sheet.getRange(row, 9).setValue('WS');
      if (data.press.data) {
        sheet.getRange(row, 10).setValue(data.press.data.sets);
        sheet.getRange(row, 11).setValue(data.press.data.reps);
        sheet.getRange(row, 12).setValue(data.press.data.weight);
      }
    }
  }
  
  // Update pull if provided
  if (data.pull !== undefined) {
    if (data.pull === null) {
      sheet.getRange(row, 14, 1, 5).clearContent();
    } else if (data.pull.lift) {
      sheet.getRange(row, 14).setValue(data.pull.lift);
      sheet.getRange(row, 15).setValue('WS');
      if (data.pull.data) {
        sheet.getRange(row, 16).setValue(data.pull.data.sets);
        sheet.getRange(row, 17).setValue(data.pull.data.reps);
        sheet.getRange(row, 18).setValue(data.pull.data.weight);
      }
    }
  }
  
  // Update accessory if provided
  if (data.accessory !== undefined) {
    if (data.accessory === null) {
      sheet.getRange(row, 20, 1, 5).clearContent();
    } else if (data.accessory.lift) {
      sheet.getRange(row, 20).setValue(data.accessory.lift);
      sheet.getRange(row, 21).setValue('WS');
      if (data.accessory.data) {
        sheet.getRange(row, 22).setValue(data.accessory.data.sets);
        sheet.getRange(row, 23).setValue(data.accessory.data.reps);
        sheet.getRange(row, 24).setValue(data.accessory.data.weight);
      }
    }
  }
  
  return ContentService.createTextOutput(JSON.stringify({success: true}))
    .setMimeType(ContentService.MimeType.JSON);
}

function findFirstEmptyRow(sheet) {
  const lastRow = sheet.getLastRow();
  
  // If sheet is empty or only has headers
  if (lastRow < 9) return 9;
  
  // Get all dates from row 9 to last row
  const values = sheet.getRange(9, 1, lastRow - 8, 1).getValues().flat();
  
  // Find first empty cell
  for (let i = 0; i < values.length; i++) {
    if (!values[i]) {
      return 9 + i;
    }
  }
  
  // If no empty cells found, return next row
  return lastRow + 1;
}

function writeWorkoutRow(sheet, data) {
  const row = findFirstEmptyRow(sheet);
  
  // Write date to column A
  sheet.getRange(row, 1).setValue(data.date);
  
  // Squat section (B-F)
  if (data.squat && data.squat.lift) {
    sheet.getRange(row, 2).setValue(data.squat.lift);
    sheet.getRange(row, 3).setValue('WS');
    if (data.squat.data) {
      sheet.getRange(row, 4).setValue(data.squat.data.sets);
      sheet.getRange(row, 5).setValue(data.squat.data.reps);
      sheet.getRange(row, 6).setValue(data.squat.data.weight);
    }
  }
  
  // Press section (H-L)
  if (data.press && data.press.lift) {
    sheet.getRange(row, 8).setValue(data.press.lift);
    sheet.getRange(row, 9).setValue('WS');
    if (data.press.data) {
      sheet.getRange(row, 10).setValue(data.press.data.sets);
      sheet.getRange(row, 11).setValue(data.press.data.reps);
      sheet.getRange(row, 12).setValue(data.press.data.weight);
    }
  }
  
  // Pull section (N-S)
  if (data.pull && data.pull.lift) {
    sheet.getRange(row, 14).setValue(data.pull.lift);
    sheet.getRange(row, 15).setValue('WS');
    if (data.pull.data) {
      sheet.getRange(row, 16).setValue(data.pull.data.sets);
      sheet.getRange(row, 17).setValue(data.pull.data.reps);
      sheet.getRange(row, 18).setValue(data.pull.data.weight);
    }
  }
  
  // Accessories section (T-X)
  if (data.accessory && data.accessory.lift) {
    sheet.getRange(row, 20).setValue(data.accessory.lift);
    sheet.getRange(row, 21).setValue('WS');
    if (data.accessory.data) {
      sheet.getRange(row, 22).setValue(data.accessory.data.sets);
      sheet.getRange(row, 23).setValue(data.accessory.data.reps);
      sheet.getRange(row, 24).setValue(data.accessory.data.weight);
    }
  }
  
  // Notes (Y - column 25)
  if (data.notes) {
    sheet.getRange(row, 25).setValue(data.notes);
  }
}

function addNewLift(category, liftName) {
  const liftSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Lift List');
  
  const columnMap = {
    'squat': 1,
    'upper': 2,
    'pull': 3,
    'accessory': 4
  };
  
  const column = columnMap[category];
  if (!column) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: 'Invalid category'
    })).setMimeType(ContentService.MimeType.JSON);
  }
  
  let row = 1;
  while (liftSheet.getRange(row, column).getValue() !== '') {
    row++;
  }
  
  liftSheet.getRange(row, column).setValue(liftName);
  
  return ContentService.createTextOutput(JSON.stringify({
    success: true,
    lift: liftName
  })).setMimeType(ContentService.MimeType.JSON);
}

function doGet(e) {
  const param = e.parameter.action;
  
  // Get recent workouts
  if (param === 'getRecent') {
    return getRecentWorkouts();
  }
  
  // Get lift lists (default)
  const liftSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Lift List');
  
  if (!liftSheet) {
    return ContentService.createTextOutput(JSON.stringify({
      error: 'Lift List sheet not found'
    })).setMimeType(ContentService.MimeType.JSON);
  }
  
  const squatLifts = liftSheet.getRange('A:A').getValues().flat().filter(v => v !== '');
  const upperLifts = liftSheet.getRange('B:B').getValues().flat().filter(v => v !== '');
  const pullLifts = liftSheet.getRange('C:C').getValues().flat().filter(v => v !== '');
  const accessoryLifts = liftSheet.getRange('D:D').getValues().flat().filter(v => v !== '');
  
  const lifts = {
    squat: squatLifts,
    upper: upperLifts,
    pull: pullLifts,
    accessory: accessoryLifts
  };
  
  return ContentService.createTextOutput(JSON.stringify(lifts))
    .setMimeType(ContentService.MimeType.JSON);
}

function getRecentWorkouts() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Training Log 2026');
  const lastRow = sheet.getLastRow();
  
  if (lastRow < 9) {
    return ContentService.createTextOutput(JSON.stringify({workouts: []}))
      .setMimeType(ContentService.MimeType.JSON);
  }
  
  // Get last 3 rows (or fewer if less than 3 exist)
  const numRows = Math.min(3, lastRow - 8);
  const startRow = lastRow - numRows + 1;
  
  const data = sheet.getRange(startRow, 1, numRows, 25).getValues();
  
  const workouts = [];
  
  for (let i = data.length - 1; i >= 0; i--) {
    const row = data[i];
    const rowNumber = startRow + i;
    
    const workout = {
      row: rowNumber,
      date: row[0] ? formatDate(row[0]) : ''
    };
    
    // Squat (columns B-F: 1-5)
    if (row[1]) {
      workout.squat = {
        lift: row[1],
        sets: row[3] || '',
        reps: row[4] || '',
        weight: row[5] || ''
      };
    }
    
    // Press (columns H-L: 7-11)
    if (row[7]) {
      workout.press = {
        lift: row[7],
        sets: row[9] || '',
        reps: row[10] || '',
        weight: row[11] || ''
      };
    }
    
    // Pull (columns N-R: 13-17)
    if (row[13]) {
      workout.pull = {
        lift: row[13],
        sets: row[15] || '',
        reps: row[16] || '',
        weight: row[17] || ''
      };
    }
    
    // Accessories (columns T-X: 19-23)
    if (row[19]) {
      workout.accessory = {
        lift: row[19],
        sets: row[21] || '',
        reps: row[22] || '',
        weight: row[23] || ''
      };
    }
    
    workouts.push(workout);
  }
  
  return ContentService.createTextOutput(JSON.stringify({workouts: workouts}))
    .setMimeType(ContentService.MimeType.JSON);
}

function formatDate(date) {
  if (typeof date === 'string') return date;
  const d = new Date(date);
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  const year = d.getFullYear();
  return `${month}/${day}/${year}`;
}
